
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Justin Collins' Blugh</title>
  <meta name="author" content="Justin Collins">

  
  <meta name="description" content="If you are using Cloudflare, it can be helpful to configure Cloudflare to push request logs to S3. Otherwise, the Cloudflare dashboard provides only &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://blog.presidentbeef.com">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Justin Collins' Blugh" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@presidentbeef" />
<meta name="twitter:title" content="Justin Collins' Blugh" />
<meta name="description" content="If you are using Cloudflare, it can be helpful to configure Cloudflare to push request logs to S3. Otherwise, the Cloudflare dashboard provides only &hellip;">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20920647-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  
    <h2><a href="/">*.blog</a></h2>
  
  <em>by <a style="text-decoration: none" href="http://presidentbeef.com">Justin Collins</a></em>
</hgroup>

</header>
  <nav role="navigation">
  
<ul class="main-navigation">
  <li><a href="/">Recent</a></li>
  <li><a href="/blog/archives">All</a></li>
  <li><a href="https://twitter.com/presidentbeef">Twitter</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/02/17/automatically-partitioning-cloudflare-logs-for-athena/">Automatically Partitioning Cloudflare Logs for Athena</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-02-17T21:00:00-08:00" pubdate data-updated="true">Feb 17<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you are using Cloudflare, it can be helpful to <a href="https://developers.cloudflare.com/logs/get-started/enable-destinations/aws-s3">configure Cloudflare to push request logs to S3</a>. Otherwise, the Cloudflare dashboard provides only a limited view into your data (72 hours at a time and sampled data instead of full logs).</p>

<p>Once the Cloudflare request logs are in S3, they can be queried using <a href="https://aws.amazon.com/athena/">Athena</a>. <a href="https://duffn.medium.com/analyzing-cloudflare-logs-with-aws-athena-19c1399c91e3">This blog post</a> even provides a nice <code>CREATE TABLE</code> command to set up the table in Athena.</p>

<p>However, there is a problem. When performing a query in Athena, it <em>might</em> have to scan <em>all</em> of the logs in S3, even if you try to limit the query. This can be slow and costly, as Athena queries are charged per byte scanned.</p>

<p>The only way to really limit the amount of data scanned is to <a href="https://docs.aws.amazon.com/athena/latest/ug/partitions.html">partition the data</a>.</p>

<p>This post assumes you have already set up Cloudflare to push logs to an S3 bucket, configured a database in Athena to access it, and then realized those logs will grow forever, along with your query times.</p>

<p>(If you just want the &#8220;how to&#8221; without the exposition, jump down to &#8220;Setting Up Partitions for Cloudflare Logs&#8221;.)</p>

<h3>Partitioning</h3>

<p>Most commonly, you will want to look at logs from a specific time period, so it makes sense to partition the logs by date.</p>

<p>Most of the partitioning documentation suggests the files (or in this case, S3 objects) include a <code>column=value</code> key pair in the name. The <code>column</code> can then be used as a partition.</p>

<p>Unfortunately, Cloudflare does not allow customizing the format of the file names it produces.</p>

<p><em>Fortunately</em>, the file names do include date/time information. The logs are grouped by date and time range:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>s3://mah_s3_bucket/20210812/20210812T223000Z_20210812T224000Z_9af500e2.log.gz</span></code></pre></td></tr></table></div></figure>


<p>So all we need to do is grab that date &#8220;folder&#8221; name and that&#8217;s our partition! Easy, right?</p>

<p>No, wrong. This is AWS. <em>Nothing is easy.</em></p>

<h3>Use a Recurring Job?</h3>

<p>Several of the AWS documentation pages suggest using <code>ALTER TABLE</code> to <a href="https://docs.aws.amazon.com/athena/latest/ug/alter-table-add-partition.html"><code>ADD PARTITION</code>s</a>.</p>

<p>Something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">cloudflare_logs</span> <span class="k">ADD</span>
</span><span class='line'>  <span class="n">PARTITION</span> <span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="s1">&#39;2021-08-12&#39;</span><span class="p">)</span> <span class="k">LOCATION</span> <span class="s1">&#39;s3://mah_log_bucket/20210812/&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But since the logs will grow every day, we&#8217;ll need to add new a new partition every 24 hours. It is not possible to &#8220;predefine&#8221; the partitions.</p>

<p>This requires setting up a recurring job&#8230; somewhere&#8230; to periodically define the new partitions. So now we have to pull in <em>another</em> AWS service to make S3 and Athena work nicely?! No thanks!</p>

<h3>Partition Projection</h3>

<p>At the bottom of the page about partitions, there is a paragraph about &#8221;<a href="https://docs.aws.amazon.com/athena/latest/ug/partitions.html#partitions-partition-projection">partition projection</a>&#8221; that sounds promising:</p>

<blockquote><p>To avoid having to manage partitions, you can use partition projection. Partition projection is an option for highly partitioned tables whose structure is known in advance.</p></blockquote>

<p>Yes, this is what we want! But how does it work?</p>

<p>Essentially like this:</p>

<p>We must define a column, its type, start and end values, and the interval between those values. Athena will then be able to extrapolate all the possible values.</p>

<p>Then we define a pattern to pull the value out of each S3 object <em>name</em>. This allows Athena to figure out which objects (logs) are associated with which partition value.</p>

<p>For example, the partition <code>20210812</code> will be associated with <code>s3://mah_s3_bucket/20210812/20210812T223000Z_20210812T224000Z_9af500e2.log.gz</code></p>

<p>Once that&#8217;s all done, we can query based on the partition as if it were a column, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">cloudflare_logs</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">log_date</span> <span class="o">&gt;=</span> <span class="s1">&#39;20210812&#39;</span>
</span><span class='line'>  <span class="k">AND</span> <span class="n">log_date</span> <span class="o">&lt;</span> <span class="s1">&#39;20210901&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setting Up Partitions for Cloudflare Logs</h2>

<p>Here are the steps that <em>must</em> be taken to set up the partitions:</p>

<ol>
<li>Add the partition &#8220;column&#8221; when creating the table</li>
<li>Set several properties on the table to define the projection</li>
<li>Set the partition pattern to match against object names</li>
<li>Enable projection</li>
</ol>


<p>(Actually, 2-4 are all the same: set (totally unvalidated) key-value properties on the table.)</p>

<p>Fortunately, all of this can be accomplished with one giant Athena command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">YOUR_TABLE_NAME</span><span class="o">`</span><span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">botscore</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">botscoresrc</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">cachecachestatus</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">cacheresponsebytes</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">cacheresponsestatus</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientasn</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientcountry</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientdevicetype</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientip</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientipclass</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequestbytes</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequesthost</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequestmethod</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequestpath</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequestprotocol</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequestreferer</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequesturi</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientrequestuseragent</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientsslcipher</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientsslprotocol</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">clientsrcport</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgecolocode</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgecoloid</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeendtimestamp</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgepathingop</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgepathingsrc</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgepathingstatus</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeratelimitaction</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeratelimitid</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgerequesthost</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeresponsebytes</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeresponsecontenttype</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeresponsestatus</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgeserverip</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">edgestarttimestamp</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">firewallmatchesactions</span><span class="o">`</span> <span class="nb">array</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">firewallmatchesruleids</span><span class="o">`</span> <span class="nb">array</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">firewallmatchessources</span><span class="o">`</span> <span class="nb">array</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">originip</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">originresponsestatus</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">originresponsetime</span><span class="o">`</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">originsslprotocol</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">rayid</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">wafaction</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">wafflags</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">wafmatchedvar</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">wafprofile</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">wafruleid</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">wafrulemessage</span><span class="o">`</span> <span class="n">string</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">workersubrequest</span><span class="o">`</span> <span class="nb">boolean</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">zoneid</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">)</span>
</span><span class='line'><span class="n">PARTITIONED</span> <span class="k">BY</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">YOUR_COLUMN_NAME</span><span class="o">`</span> <span class="n">string</span><span class="p">)</span>
</span><span class='line'><span class="k">ROW</span> <span class="n">FORMAT</span> <span class="n">SERDE</span>
</span><span class='line'>  <span class="s1">&#39;org.openx.data.jsonserde.JsonSerDe&#39;</span>
</span><span class='line'><span class="n">STORED</span> <span class="k">AS</span> <span class="n">INPUTFORMAT</span>
</span><span class='line'>  <span class="s1">&#39;org.apache.hadoop.mapred.TextInputFormat&#39;</span>
</span><span class='line'><span class="n">OUTPUTFORMAT</span>
</span><span class='line'>  <span class="s1">&#39;org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat&#39;</span>
</span><span class='line'><span class="k">LOCATION</span>
</span><span class='line'>  <span class="s1">&#39;s3://YOUR_BUCKET_NAME/&#39;</span>
</span><span class='line'><span class="n">TBLPROPERTIES</span> <span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;projection.enabled&#39;</span><span class="o">=</span><span class="s1">&#39;TRUE&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;projection.YOUR_COLUMN_NAME.format&#39;</span><span class="o">=</span><span class="s1">&#39;yyyyMMdd&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;projection.YOUR_COLUMN_NAME.interval&#39;</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;projection.YOUR_COLUMN_NAME.interval.unit&#39;</span><span class="o">=</span><span class="s1">&#39;DAYS&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;projection.YOUR_COLUMN_NAME.range&#39;</span><span class="o">=</span><span class="s1">&#39;YOUR_START_DATE,NOW&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;projection.YOUR_COLUMN_NAME.type&#39;</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'> <span class="s1">&#39;storage.location.template&#39;</span><span class="o">=</span><span class="s1">&#39;s3://YOUR_BUCKET_NAME/${YOUR_COLUMN_NAME}/&#39;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>These are the pieces related to partitioning:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">PARTITIONED</span> <span class="k">BY</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">YOUR_COLUMN_NAME</span><span class="o">`</span> <span class="n">string</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This tells Athena to set up a column for the partition.</p>

<p>(The type of the partition column <strong>must</strong> be <code>string</code>, even though the projection type <strong>must</strong> be <code>date</code>. Does this make any sense? <strong>NO</strong>.)</p>

<p>Then the table properties.</p>

<p>Turn on projection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="s1">&#39;projection.enabled&#39;</span><span class="o">=</span><span class="s1">&#39;TRUE&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set the column type to date:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="s1">&#39;projection.YOUR_COLUMN_NAME.type&#39;</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is so Athena knows how to interpolate values.</p>

<p>Define the date format to match:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="s1">&#39;projection.YOUR_COLUMN_NAME.format&#39;</span><span class="o">=</span><span class="s1">&#39;yyyyMMdd&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set the interval for the values to one day:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="s1">&#39;projection.YOUR_COLUMN_NAME.interval&#39;</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span><span class='line'><span class="s1">&#39;projection.YOUR_COLUMN_NAME.interval.unit&#39;</span><span class="o">=</span><span class="s1">&#39;DAYS&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set the range for the values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="s1">&#39;projection.YOUR_COLUMN_NAME.range&#39;</span><span class="o">=</span><span class="s1">&#39;YOUR_START_DATE,NOW&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>NOW</code> is a special value so the end of the range will always be the current day.</p>

<p>This sets a template to extract the date string from the object name, using the date template defined above, and setting the value in the column name specified for the projection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="s1">&#39;storage.location.template&#39;</span><span class="o">=</span><span class="s1">&#39;s3://YOUR_BUCKET_NAME/${YOUR_COLUMN_NAME}/&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are unfamiliar with Athena, it&#8217;s good to know that deleting/creating tables is low impact. If the table is already created, it is not a big deal to delete it and start over.</p>

<p>Here are the important bits above that you will need to change:</p>

<ul>
<li><code>YOUR_TABLE_NAME</code> is whatever you want to name the table. Something like <code>cloudflare_logs</code> would probably make sense.</li>
<li><code>YOUR_COLUMN_NAME</code> is whatever you want to name the projection &#8220;column&#8221;. Could be <code>dt</code> like in the AWS docs, or <code>log_date</code> or whatever you want.</li>
<li><code>YOUR_BUCKET_NAME</code> is the name of the S3 bucket.</li>
<li><code>YOUR START_DATE</code> is the date of the first log. Something like <code>20210101</code>.</li>
</ul>


<p>The table should now indicate it is partitioned:</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z17sufwwkndnfbygh7xm.png" alt="Table name with text 'partitioned' next to it" /></p>

<p>And the partition should show up as a column:</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2k9ixdqd6820stqrvetr.png" alt="Column name with text 'string (partitioned)' next to it" /></p>

<h3>Using Date Partitions</h3>

<p>To test if partitions are working as expected, a quick query like this will work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="k">DISTINCT</span><span class="p">(</span><span class="n">YOUR_COLUMN_NAME</span><span class="p">)</span>
</span><span class='line'><span class="k">FROM</span> <span class="ss">&quot;YOUR_TABLE_NAME&quot;</span>
</span><span class='line'><span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The expected output is several dates for which there are logs.</p>

<p>Once that is confirmed, the partition column can be used like any other column. Since the values is a basic ISO date format, comparison operators can be safely used even though the column is really just a string.</p>

<p>For a single day:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">YOUR_TABLE</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">YOUR_COLUMN_NAME</span> <span class="o">=</span> <span class="ss">&quot;20200101&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For an inclusive range:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">YOUR_TABLE</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">YOUR_COLUMN_NAME</span> <span class="o">&gt;=</span> <span class="ss">&quot;20200101&quot;</span>
</span><span class='line'>  <span class="k">AND</span> <span class="n">YOUR_COLUMN_NAME</span> <span class="o">&lt;=</span> <span class="ss">&quot;20210101&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now your queries can be faster and cheaper!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/01/31/sounds-in-dragonruby/">Sounds in DragonRuby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-01-31T11:00:00-08:00" pubdate data-updated="true">Jan 31<span>st</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The sound API in <a href="https://dragonruby.itch.io/dragonruby-gtk">DragonRuby</a> is a little tricky because at first it seems similar to the sprite API (e.g. using <code>args.outputs</code>) but it diverges sharply when you want to have some more control.</p>

<p>So let&#8217;s take a quick look at audio in DragonRuby!</p>

<h3>Simple Music</h3>

<p>As usual with DragonRuby, the simple stuff is simple.</p>

<p>To play a looping sound, for example as background music, get a sound file in <code>.ogg</code> format and then add it on to <code>args.outputs.sounds</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">sounds</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;sounds/my_music.ogg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The audio will loop forever.</p>

<h3>Simple Sound Effects</h3>

<p>Want to fire off a single sound effect?</p>

<p>Get a sound file in <code>.wav</code> format and then add it on to <code>args.outputs.sounds</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">sounds</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;sounds/my_effect.wav&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The sound will play once.</p>

<p><em>Wait so the API behaves differently based on the file format?</em></p>

<p>Yep. A little odd but it works.</p>

<h3>Adjusting the Volume Knob</h3>

<p>Playing a sound effect in DragonRuby is pretty easy. But what if we need to adjust the volume or some other attribute of the audio? Or maybe loop a <code>.wav</code> or not loop a <code>.ogg</code> file?</p>

<p>You might think, based on how sprites work in DragonRuby, you could do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># This does not work!</span>
</span><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">sounds</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">input</span><span class="p">:</span> <span class="s1">&#39;sounds/my_music.ogg&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">gain</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span>      <span class="c1"># Half volume</span>
</span><span class='line'>  <span class="ss">looping</span><span class="p">:</span> <span class="kp">false</span>  <span class="c1"># Don&#39;t loop</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But this does not work.</p>

<p>Instead, you need to use an entirely different interface: <code>args.audio</code>.</p>

<p><code>args.audio</code> is a hash table of sounds.</p>

<p>To add a new sound, assign it with a name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">audio</span><span class="o">[</span><span class="ss">:music</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">input</span><span class="p">:</span> <span class="s1">&#39;sounds/my_music.ogg&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">gain</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">looping</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To adjust an attribute of the audio, access it by the same name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Turn up the volume</span>
</span><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">audio</span><span class="o">[</span><span class="ss">:music</span><span class="o">].</span><span class="n">gain</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">75</span>
</span></code></pre></td></tr></table></div></figure>


<p>To pause a sound:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">audio</span><span class="o">[</span><span class="ss">:music</span><span class="o">].</span><span class="n">paused</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>To completely remove a sound:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">audio</span><span class="o">.</span><span class="n">delete</span> <span class="ss">:music</span>
</span></code></pre></td></tr></table></div></figure>


<h3>More Music Manipulation</h3>

<p>This is the full set of options for audio from <a href="http://docs.dragonruby.org/#--docs---gtk--args#audio-">the documentation</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">audio</span><span class="o">[</span><span class="ss">:my_music</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">input</span><span class="p">:</span> <span class="s1">&#39;sounds/my_music.ogg&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="ss">z</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>   <span class="c1"># Relative position to the listener, x, y, z from -1.0 to 1.0</span>
</span><span class='line'>  <span class="ss">gain</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>                <span class="c1"># Volume (0.0 to 1.0)</span>
</span><span class='line'>  <span class="ss">pitch</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>               <span class="c1"># Pitch of the sound (1.0 = original pitch)</span>
</span><span class='line'>  <span class="ss">paused</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>            <span class="c1"># Set to true to pause</span>
</span><span class='line'>  <span class="ss">looping</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>           <span class="c1"># Set to true to loop</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/01/24/dragon-ruby-render-targets/">DragonRuby: Render Targets</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-01-24T11:00:00-08:00" pubdate data-updated="true">Jan 24<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Next up in my notes on <a href="https://dragonruby.itch.io/dragonruby-gtk">DragonRuby</a>: render targets!</p>

<p>Weirdly, the <a href="http://docs.dragonruby.org/#----advanced-rendering---simple-render-targets---main-rb">documentation on DragonRuby&#8217;s render targets</a> is limited to example code. Personally, I prefer prose when I am trying to learn&#8230; so here we are!</p>

<p>In DragonRuby, a render target is like an infinite canvas you can render as many regular sprites onto as you want, then manipulate the whole thing as if it is one sprite.</p>

<p>This is especially good for things like tiled backgrounds that are built once and do not change.</p>

<p>Let&#8217;s take an example.</p>

<h2>Clouds!</h2>

<p>Let&#8217;s start off very simple and build up.</p>

<p>First, here&#8217;s all the code to render a single 250x250 pixel image to the screen:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">clouds</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;sprites/cloud.png&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">sprites</span> <span class="o">&lt;&lt;</span> <span class="n">clouds</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o4bpadbxwln2zp3gsuai.png" alt="Single cloud tile" /></p>

<h3>More Clouds</h3>

<p>Cool, but I&#8217;d like to fill the whole window with clouds, so I&#8217;m going to tile them.</p>

<p>The code below makes a 6x3 grid of the cloud image.</p>

<p>(In DragonRuby, the screen is always 1280x720. Our grid is 1500x750 but I&#8217;m not trying to be too precise with the numbers here.)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">clouds</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">6</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">y</span><span class="o">|</span>
</span><span class='line'>      <span class="n">clouds</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">*</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">h</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">w</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;sprites/cloud.png&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">sprites</span> <span class="o">&lt;&lt;</span> <span class="n">clouds</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o99o7jjmnfxupewak1n9.png" alt="Screen full of blue clouds" /></p>

<p>Ah&#8230; blue clouds. Nice.</p>

<p>On every tick, the code builds up an array of 18 sprites (images) and renders it out to the screen.</p>

<p>(There are a number of ways to make this more efficient - check out the <a href="https://dev.to/presidentbeef/series/16166">previous posts</a> in this series for different ways to &#8220;cache&#8221; the sprite information.)</p>

<h3>Render Targets</h3>

<p>But in this post we are talking about render targets - which is a way of rendering a bunch of sprites (or any other renderable thing) just once, and then treating the whole group of sprites as a single sprite. This is <em>faster</em>, simpler, and enables some neat effects.</p>

<p>The code only needs minor changes to switch the cloud grid to using a render target instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Move cloud grid creation into a helper method</span>
</span><span class='line'><span class="k">def</span> <span class="nf">make_clouds</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="n">clouds</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">6</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">y</span><span class="o">|</span>
</span><span class='line'>      <span class="n">clouds</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">*</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">h</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">w</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;sprites/cloud.png&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Similar to `args.outputs`,</span>
</span><span class='line'>  <span class="c1"># render targets have `.sprites`, `.solids`, etc.</span>
</span><span class='line'>  <span class="c1"># The argument will be used as the path below</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">render_target</span><span class="p">(</span><span class="ss">:clouds</span><span class="p">)</span><span class="o">.</span><span class="n">sprites</span> <span class="o">&lt;&lt;</span> <span class="n">clouds</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Set up the render target on the first tick</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tick_count</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">make_clouds</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Output a single sprite</span>
</span><span class='line'>  <span class="c1"># located at 0,0 and the size of the whole grid</span>
</span><span class='line'>  <span class="c1"># created in `make_clouds`</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">sprites</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">250</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">250</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">path</span><span class="p">:</span> <span class="ss">:clouds</span> <span class="c1"># Name of the render target!</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>For convenience, the code above moves the creation of the cloud grid and the render target into a helper method which gets called on the first tick of the game.</p>

<p><code>args.render_target(:clouds)</code> automatically creates a new render target named <code>:clouds</code> if it does not already exist. Then we can render things to it just as if it were <code>args.outputs</code>.</p>

<p>Interestingly, render targets do not seem to have an innate width or height. In order to avoid unintentional scaling, you will need to &#8220;know&#8221; how big the render target is. In this case, we know it is a 6x3 grid of 250x250 images, so the size is fairly straightforward. I left the math in to make it clearer.</p>

<p>Finally, we reference the render target similarly to an image file, but pass in the name of the render target as the <code>:path</code> instead of an actual file path.</p>

<h2>Static Sprites, Too!</h2>

<p><a href="https://blog.presidentbeef.com/blog/2022/01/08/dragon-ruby-static-outputs/">As explored in a different post</a>, we can use <code>static_sprites</code> to &#8220;render&#8221; the sprite <em>once</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># No changes here</span>
</span><span class='line'><span class="k">def</span> <span class="nf">make_clouds</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="n">clouds</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">6</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">y</span><span class="o">|</span>
</span><span class='line'>      <span class="n">clouds</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">*</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">h</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">w</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;sprites/cloud.png&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">render_target</span><span class="p">(</span><span class="ss">:clouds</span><span class="p">)</span><span class="o">.</span><span class="n">sprites</span> <span class="o">&lt;&lt;</span> <span class="n">clouds</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tick_count</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">make_clouds</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Create the clouds sprite once</span>
</span><span class='line'>    <span class="c1"># and keep it in `args.state`.</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">clouds</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">w</span><span class="p">:</span> <span class="mi">250</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">h</span><span class="p">:</span> <span class="mi">250</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">path</span><span class="p">:</span> <span class="ss">:clouds</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Add the clouds sprite just once</span>
</span><span class='line'>    <span class="c1"># as a &quot;static&quot; sprite</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">static_sprites</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">clouds</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now we can move the clouds around just by changing the attributes on the render target.</p>

<p>Adding a little bit of code at the end of <code>tick</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">clouds</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="no">Math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tick_count</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-</span> <span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<p>(The calculation and numbers aren&#8217;t really important here, I just fiddled around until something looked decent.)</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/hw1qpqotbcg6pfpqo2bq.gif" alt="Clouds moving back and forth" /></p>

<p>Oh hey! Those extra pixels on the sides of the cloud grid actually came in handy.</p>

<h3>What Else?</h3>

<p>Remember, the entire render target is like one sprite now. That means all the regular sprite attributes (e.g. color, size, blending, flipping, rotation) can be applied to the entire thing at once.</p>

<p><em>Wait, did you say rotation?</em></p>

<p>Sure, let&#8217;s make ourselves dizzy.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">clouds</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="p">(</span><span class="no">Math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tick_count</span> <span class="o">/</span> <span class="mi">120</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g5n2ug9ehwbn8yzh2orq.gif" alt="Spinning clouds" /></p>

<p>Okay, that&#8217;s as deep as we&#8217;ll go on render targets in this post!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/01/15/a-object-oriented-starter-for-dragonruby/">DragonRuby: Object-Oriented Starter</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-01-15T11:00:00-08:00" pubdate data-updated="true">Jan 15<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I enjoy playing with the <a href="https://dragonruby.itch.io/dragonruby-gtk">DragonRuby Game Toolkit</a>, but the <a href="http://docs.dragonruby.org/">documentation</a> and many of the examples are very much intended for non-Rubyists. Additionally, as a game engine, it&#8217;s more data/functionally-oriented than most Rubyists are used to. For example, the main game loop in the <code>tick</code> method needs to be implemented as a top-level method.</p>

<p>This post walks through structuring a game in a way that is a little more familiar to Rubyists.</p>

<p><em>Caveat!</em> I am new to DragonRuby myself and this is not meant to be the &#8220;correct&#8221; or &#8220;best&#8221; or even &#8220;great&#8221; way to organize your code. It&#8217;s just a pattern I&#8217;ve started using and it might be useful for you!</p>

<p>(By the way, while DragonRuby is a commercial product, you can often <a href="https://dragonruby.itch.io/dragonruby-gtk">grab a free copy</a>. Keep an eye out for sales!)</p>

<h3>Starting Example</h3>

<p>First, let&#8217;s start with some code that isn&#8217;t using any class definitions at all. Everything happens inside <code>tick</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Set up player object</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span> <span class="o">||=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Move player based on keyboard input</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keyboard</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">args</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keyboard</span><span class="o">.</span><span class="n">right</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">args</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keyboard</span><span class="o">.</span><span class="n">down</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">args</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keyboard</span><span class="o">.</span><span class="n">up</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Render the &quot;player&quot; as a square to the screen</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/79w79at48p6lh0zeo08r.gif" alt="DragonRuby Example - Moving a black square around" /></p>

<p>As a reminder, DragonRuby automatically loads up code from a file called <code>mygame/app/main.rb</code> and then calls <code>tick</code> 60 times per second.</p>

<p><code>args.state</code> is like an OpenStruct where you can add on whatever attributes you want and store whatever you would like. In this case, we add a hash that we name <code>player</code>.</p>

<p>The code then checks for keyboard input and adjusts the position of the &#8220;player&#8221;. (To keep things very simple, we don&#8217;t worry about keeping the player on the screen.)</p>

<p>Finally, we render the &#8220;player&#8221; as a solid square.</p>

<p>This is simple enough and the code isn&#8217;t too complicated. But, just for fun, let&#8217;s slowly transform it to be a little more &#8220;object-oriented&#8221;.</p>

<h3>Game Object</h3>

<p>First, let&#8217;s create a main &#8220;game&#8221; object to hold our logic, instead of putting it all in <code>tick</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyGame</span>
</span><span class='line'>  <span class="c1"># Adds convenience methods for args, gtk, keyboard, etc.</span>
</span><span class='line'>  <span class="n">attr_gtk</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">x</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">y</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">w</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">h</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tick</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>      <span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">right</span>
</span><span class='line'>      <span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">down</span>
</span><span class='line'>      <span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">up</span>
</span><span class='line'>      <span class="n">state</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">state</span><span class="o">.</span><span class="n">player</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span> <span class="o">||=</span> <span class="no">MyGame</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">tick</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the <code>tick</code> method only sets up the global <code>$my_game</code> on the first tick, then sets <code>args</code> on each tick and calls the game&#8217;s <code>tick</code> method.</p>

<p>(<em>Tangent alert!</em> Is it necessary to set <code>args</code> on every tick? Not strictly - you could set <code>self.args = args</code> in <code>initialize</code> and it will work okay. But if you want to use DragonRuby&#8217;s unit test framework, it may cause problems because each test has a fresh copy of <code>args</code>.)</p>

<p>Using <code>attr_gtk</code> allows the code to be a bit shorter. <code>args</code>, <code>state</code>, <code>keyboard</code>, <a href="http://docs.dragonruby.org/#----attr_gtk-rb">and more</a> now have convenience methods for them.</p>

<h3>Instance Variables Instead of State</h3>

<p><code>args.state</code> is essentially a global variable space. This is a big convenience when a game is all top-level methods - otherwise you would have to figure out where to stash all your game state yourself.</p>

<p>However, it&#8217;s not required to use it.</p>

<p>The code below uses <code>@player</code> to store the player hash, instead of <code>args.state</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyGame</span>
</span><span class='line'>  <span class="n">attr_gtk</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:player</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">x</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">y</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">w</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">h</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tick</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">right</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">down</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">up</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span> <span class="o">||=</span> <span class="no">MyGame</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">tick</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>One thing that has thrown me off with DragonRuby is understanding just how much &#8220;regular&#8221; Ruby I can use. For the most part, other than how the <code>tick</code> method is used as the main game loop, you can use the Ruby language constructs you are comfortable with.</p>

<h3>Splitting Things Up</h3>

<p>No big change here, but as a game grows it&#8217;s easier to split the steps of each game loop into different methods.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyGame</span>
</span><span class='line'>  <span class="n">attr_gtk</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:player</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">x</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">y</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">w</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">h</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tick</span>
</span><span class='line'>    <span class="n">handle_input</span>
</span><span class='line'>    <span class="n">render</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">handle_input</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">right</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">down</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">up</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">render</span>
</span><span class='line'>    <span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span> <span class="o">||=</span> <span class="no">MyGame</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">tick</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Player Class</h3>

<p>Final step in this post - let&#8217;s move the &#8220;player&#8221; out to a separate class.</p>

<p>In this example, it might not make a lot of sense. But in most games there will be a lot of state and logic you might want to associate with the &#8220;player&#8221; or any other objects in the game. Having it be its own class helps keep the logic in one place.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyGame</span>
</span><span class='line'>  <span class="n">attr_gtk</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:player</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="no">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tick</span>
</span><span class='line'>    <span class="n">handle_input</span>
</span><span class='line'>    <span class="n">render</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">handle_input</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">right</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">down</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">up</span>
</span><span class='line'>      <span class="n">player</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">render</span>
</span><span class='line'>    <span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Player</span>
</span><span class='line'>  <span class="n">attr_sprite</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@x</span> <span class="o">=</span> <span class="n">x</span>
</span><span class='line'>    <span class="vi">@y</span> <span class="o">=</span> <span class="n">y</span>
</span><span class='line'>    <span class="vi">@w</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class='line'>    <span class="vi">@h</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span> <span class="o">||=</span> <span class="no">MyGame</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span><span class='line'>  <span class="vg">$my_game</span><span class="o">.</span><span class="n">tick</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here the code uses another DragonRuby convenience. <code>attr_sprite</code> adds a bunch of <a href="http://docs.dragonruby.org/#----attr_sprite-rb">helper methods</a> that allow you to use any object as a sprite/solid/border, etc. (Note that the code still passes <code>player</code> into <code>outputs.solids</code> and DragonRuby treats it as a solid. If it were passed into <code>outputs.sprites</code> then it would be treated like a sprite instead!)</p>

<h3>Separate Files?</h3>

<p>For the sake of a blog post, all the code is together. But there is no reason not to start splitting the code across separate files.</p>

<p>But! In DragonRuby there is one weirdness with <code>require</code>: you must include the file extension (usually <code>.rb</code>), while in regular Ruby that is usually omitted.</p>

<h2>Wrapping Up</h2>

<p>Did our code become longer and less straight-forward? Yes, for this small example, definitely.</p>

<p>But as a game (or any project) grows, pulling bits out into modular pieces is going to be an advantage. Personally I fall back on this structure pretty quickly when I start a new DragonRuby project.</p>

<p>Hopefully this post is useful to Rubyists trying to get into DragonRuby!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/01/08/dragon-ruby-static-outputs/">DragonRuby: Static Outputs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-01-08T11:00:00-08:00" pubdate data-updated="true">Jan 8<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a <a href="https://dev.to/presidentbeef/api-levels-in-dragonruby-game-toolkit-4jb4">previous post</a> we looked at different ways to render outputs (sprites, rectangles, lines, etc.) in the <a href="https://dragonruby.org/toolkit/game">DragonRuby Game Toolkit</a>.</p>

<p>The post ended by hinting at a more efficient way to render outputs instead of adding them to e.g. <code>args.outputs.solids</code> or <code>args.outputs.sprites</code> each tick.</p>

<p>This post explores the world of &#8220;static outputs&#8221;!</p>

<h2>Static What?</h2>

<p>First of all, we should address the most confusing part of all this.</p>

<p><strong>&#8220;Static&#8221; does not mean the images don&#8217;t move or change.</strong> Instead, it means that render &#8220;queue&#8221; is not cleared after every tick.</p>

<p>Normally, one would load up the queue each tick, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Render a black rectangle</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># width</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">400</span>   <span class="c1"># height</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But this is kind of wasteful. We are creating a new hash table each tick (60 ticks/second) and then throwing it away. Also each tick we are filling up the <code>args.outputs.solids</code> queue and then emptying it.</p>

<p>Instead, why not create the hash table once, load up the queue once, and then re-use them?</p>

<p>That&#8217;s the idea of static outputs!</p>

<p>There are static versions for each rendered type:</p>

<ul>
<li><code>args.outputs.static_borders</code></li>
<li><code>args.outputs.static_labels</code></li>
<li><code>args.outputs.static_primitives</code></li>
<li><code>args.outputs.static_solids</code></li>
<li><code>args.outputs.static_sprites</code></li>
</ul>


<h2>Going Static</h2>

<h3>Starting Out</h3>

<p>Here&#8217;s an example with comments explaining what the code is doing. This &#8220;game&#8221; simply moves a square back and forth across the screen. This is the entire program!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="c1"># Initialize the x location of the square</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">x</span> <span class="o">||=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Initialize the direction/velocity</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span> <span class="o">||=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># If we hit the sides, change direction</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">right</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Update the x location</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Build the square</span>
</span><span class='line'>  <span class="n">square</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Add the square to the render queue</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">square</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The resulting output looks like:</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o56m4w483wxr46y07zh0.gif" alt="Image description" /></p>

<p>This example introduces <code>args.state</code>. This is basically a persistent bag you can throw anything into. (For Rubyists - this is like <a href="https://ruby-doc.org/stdlib-3.1.0/libdoc/ostruct/rdoc/OpenStruct.html">OpenStruct</a>.)</p>

<p><code>x</code> and <code>direction</code> are not special, they are just variables we are defining. We use <code>||=</code> to initialize them because we only want to set the values on the first tick.</p>

<p>This example illustrates the point from above - every tick it creates a new square and adds it to the queue. The queue is emptied out and then the code starts all over again.</p>

<p>Seems wasteful, right?</p>

<h3>Caching the Objects</h3>

<p>First thing I think of is - &#8220;why not create the square once, then just update the object each tick? Does that work?&#8221; Yes! It does.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span> <span class="o">||=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span> <span class="o">||=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">right</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span> <span class="o">+=</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this code, we create the <code>square</code> only once and then store it in <code>args.state.square</code>.</p>

<p>Instead of having a separate <code>x</code> variable, the code updates the <code>x</code> property on the square directly.</p>

<p>This is <em>better</em>, but we are still updating <code>args.outputs.solids</code> each tick.</p>

<h3>Full Static</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span> <span class="o">||=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span> <span class="o">||=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># On the first tick, add the square to the render queue</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tick_count</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">static_solids</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">right</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">left</span>
</span><span class='line'>    <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">square</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span> <span class="o">+=</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">direction</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this code, we use the fact that the first <code>args.tick_count</code> is <code>0</code> to add the <code>square</code> to <code>args.outputs.static_solids</code> just <em>once</em>. It will continue to be rendered on each tick.</p>

<h2>Performance</h2>

<p>Intuitively, since the code is doing less, it should be faster. But does it really make a difference?</p>

<p>It depends on your game, how much it&#8217;s doing per tick, how many sprites you are rendering, and what platform/hardware it&#8217;s running on.</p>

<p>The examples above? Not going to see any difference using <code>static_solids</code>.</p>

<p>But DragonRuby contains two examples that directly compare <code>args.outputs.sprites</code> vs. <code>args.outputs.static_sprites</code> (<a href="http://docs.dragonruby.org/#----performance---sprites-as-classes---main-rb">here</a> and <a href="http://docs.dragonruby.org/#----performance---static-sprites-as-classes---main-rb">here</a>).</p>

<p>In these examples, you can play with the number of &#8220;stars&#8221; rendered to see different performance. On my ancient laptop, I do not see a performance difference until around 3,000 stars.</p>

<p>Your mileage may vary, though!</p>

<h2>Should I Always Use the Static Versions?</h2>

<p>It depends! Probably not?</p>

<p>If your code mainly manipulates the same objects around the screen <em>and</em> always renders them in the same order, then using the <code>static_</code> approach might be simpler and faster.</p>

<p>But in many cases it might be easier to simply set up the render queues each tick, especially if the objects rendered or their ordering change regularly. Otherwise, managing the state of the rendering queues can become cumbersome. (We haven&#8217;t even talked about clearing the static queues, for example.)</p>

<p>Some of this comes down to personal preference and how you would like to structure your code. But hopefully this post has helped explain how to use the <code>args.outputs.static_*</code> methods in your game!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/01/05/api-levels-in-dragonruby-game-toolkit/">API Levels in DragonRuby Game Toolkit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-01-05T11:00:00-08:00" pubdate data-updated="true">Jan 5<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://dragonruby.org/toolkit/game">DragonRuby Game Toolkit (DRGTK)</a> is a 2D game engine built with <a href="https://mruby.org/">mRuby</a>, <a href="https://www.libsdl.org/">SDL</a>, and <a href="https://llvm.org/">LLVM</a>. It&#8217;s meant to be tiny, fast, and allow you to turn out games quickly using <a href="https://www.ruby-lang.org/">Ruby</a>.</p>

<p>Unfortunately, since the documentation is focused on making games <em>quickly</em>, I sometimes get lost when trying to figure out how to do things that should be simple. DragonRuby seems to have borrowed Perl&#8217;s &#8221;<a href="https://en.wikipedia.org/wiki/There%27s_more_than_one_way_to_do_it">There&#8217;s more than one way to do it</a>&#8221; philosophy because for anything you want to do with the API there are <em>several</em> ways to do it.</p>

<p>The documentation and examples tend to focus on the simplest forms (which is fine) but then require digging and experimentation to figure out the rest.</p>

<p>To help explain/document the different API options, this post will go through different methods of rendering images (well, rectangles mostly).</p>

<h2>API Levels</h2>

<h3>Level 0 - Getting Started</h3>

<p>The main object one interacts with in DragonRuby is canonically called <code>args</code> (always accessible with <code>$gtk.args</code>&#8230; because there&#8217;s more than one way!)</p>

<p>To output <em>things</em>, like shapes, sprites, or sounds, you can use the &#8220;shovel&#8221; operator <code>&lt;&lt;</code> on <code>args.outputs</code> - like <code>args.outputs.sprites</code> or <code>args.outputs.sounds</code>.</p>

<p>For these &#8220;basic&#8221; objects, you&#8217;ll need to shovel <em>things</em> in on every &#8220;tick&#8221; of the game engine.</p>

<p>This is a complete DragonRuby example to output a rectangle:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So far, so good.</p>

<p>(You can assume the rest of the examples below are inside a <code>tick</code> method if it&#8217;s not explicitly defined.)</p>

<h3>Level 1 - Arrays</h3>

<p>The documentation usually starts off by passing <em>things</em> to <code>args.outputs</code> as arrays - essentially positional arguments.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>What does that do? I&#8217;m not quite sure!</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p9aobr3f41cbih3kpa95.png" alt="A black rectangle on a gray background" /></p>

<p>Okay - it shows a black rectangle on the screen. Not that exciting, but useful enough for our examples.</p>

<p>The problem with using arrays though is remembering which index in the array is which attribute. On top of that, it&#8217;s not even recommended to pass in arrays because they are slow (for some reason).</p>

<h3>Level 2 - Hashes</h3>

<p>What is better than arrays? Hashes! (Hash tables/associative arrays for anyone not familiar with Ruby.)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">y</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">w</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># width</span>
</span><span class='line'>  <span class="ss">h</span><span class="p">:</span> <span class="mi">400</span>   <span class="c1"># height</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, that&#8217;s way easier to understand!</p>

<p>And there are more options, too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">solids</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">y</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">w</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">h</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">r</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># red</span>
</span><span class='line'>  <span class="ss">g</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>  <span class="c1"># green</span>
</span><span class='line'>  <span class="ss">b</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># blue</span>
</span><span class='line'>  <span class="ss">a</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># alpha</span>
</span><span class='line'>  <span class="ss">blendmode_enum</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># blend mode</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Level 3 - Primitives</h3>

<p>But there is yet another way&#8230; instead of using <code>args.outputs.solids</code>, <code>args.outputs.labels</code>, <code>args.outputs.sprites</code>, etc., we can output a hash to <code>args.outputs.primitives</code> but mark it as the right primitive &#8220;type&#8221;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">primitives</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">y</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">w</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">h</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">r</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># red</span>
</span><span class='line'>  <span class="ss">g</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>  <span class="c1"># green</span>
</span><span class='line'>  <span class="ss">b</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># blue</span>
</span><span class='line'>  <span class="ss">a</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># alpha</span>
</span><span class='line'>  <span class="ss">blendmode_enum</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># blend mode</span>
</span><span class='line'><span class="p">}</span><span class="o">.</span><span class="n">solid!</span>
</span></code></pre></td></tr></table></div></figure>


<p>Weird, but okay. Why might one want to do this? See the &#8220;Layers&#8221; section down below!</p>

<h3>Level 4 - Classes</h3>

<p>Finally, probably the most natural for a Rubyist: just use a class!</p>

<p>To do this, you <em>must</em> define all the methods expected for the type of primitive, plus define a method called <code>primitive_marker</code> that returns the type of primitive.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ACoolSolid</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">:y</span><span class="p">,</span> <span class="ss">:w</span><span class="p">,</span> <span class="ss">:h</span><span class="p">,</span> <span class="ss">:r</span><span class="p">,</span> <span class="ss">:g</span><span class="p">,</span> <span class="ss">:b</span><span class="p">,</span> <span class="ss">:a</span><span class="p">,</span> <span class="ss">:blendmode_enum</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>
</span><span class='line'>    <span class="vi">@x</span> <span class="o">=</span> <span class="n">x</span>
</span><span class='line'>    <span class="vi">@y</span> <span class="o">=</span> <span class="n">y</span>
</span><span class='line'>    <span class="vi">@w</span> <span class="o">=</span> <span class="n">w</span>
</span><span class='line'>    <span class="vi">@h</span> <span class="o">=</span> <span class="n">h</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">primitive_marker</span>
</span><span class='line'>    <span class="ss">:solid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">primitives</span> <span class="o">&lt;&lt;</span> <span class="no">ACoolSolid</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of defining a bunch of methods with <code>attr_reader</code>, you can use <code>attr_sprite</code> instead which is a DragonRuby shortcut method to do the same thing.</p>

<h2>Layers</h2>

<p>DragonRuby renders outputs in this order (from back to front):</p>

<ul>
<li>Solids</li>
<li>Sprites</li>
<li>Primitives</li>
<li>Labels</li>
<li>Lines</li>
<li>Borders</li>
</ul>


<p>For each &#8220;layer&#8221; the objects are rendered in FIFO order - the first things in the queue are rendered first.</p>

<p>But wait&#8230; one of these things is not like the others. Doesn&#8217;t <code>primitives</code> just hold things like solids, sprites, labels&#8230;?</p>

<p>Yes!</p>

<p>But using <code>primitives</code> enables better control over render order.</p>

<p>For example, what if we want to render a rectangle on top of a sprite? With the fixed rendering order above, it&#8217;s impossible! But by using <code>args.outputs.primitives</code> we can do it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">a_solid</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">400</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">solid!</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">a_sprite</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">y</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">w</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">h</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;metadata/icon.png&#39;</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">sprite!</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">primitives</span> <span class="o">&lt;&lt;</span> <span class="n">a_sprite</span> <span class="o">&lt;&lt;</span> <span class="n">a_solid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&#8217;s the proof:</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z1596wyp7n71lwya3f2c.png" alt="Screenshot showing a black rectangle on top of the DragonRuby logo" /></p>

<h2>Every Tick?</h2>

<p><code>args.outputs.sprites</code>, etc. get cleared after each call to <code>tick</code>. So every tick we have to recreate all the objects and pass them in to <code>args.outputs</code>. Seems wasteful, right? Yes, it is!</p>

<p>It&#8217;s somewhat odd that most DragonRuby examples show creating arrays or hashes for primitives each tick. It made me think somehow the rendering process was destructive - were the things added into <code>args.outputs</code> destroyed or modified in some way?</p>

<p>Turns out, no. It is fine to create e.g. a sprite representation once and render the same object each time.</p>

<p>Here we&#8217;ll use a global for demonstration purposes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ACoolSolid</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">:y</span><span class="p">,</span> <span class="ss">:w</span><span class="p">,</span> <span class="ss">:h</span><span class="p">,</span> <span class="ss">:r</span><span class="p">,</span> <span class="ss">:g</span><span class="p">,</span> <span class="ss">:b</span><span class="p">,</span> <span class="ss">:a</span><span class="p">,</span> <span class="ss">:blendmode_enum</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>
</span><span class='line'>    <span class="vi">@x</span> <span class="o">=</span> <span class="n">x</span>
</span><span class='line'>    <span class="vi">@y</span> <span class="o">=</span> <span class="n">y</span>
</span><span class='line'>    <span class="vi">@w</span> <span class="o">=</span> <span class="n">w</span>
</span><span class='line'>    <span class="vi">@h</span> <span class="o">=</span> <span class="n">h</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">primitive_marker</span>
</span><span class='line'>    <span class="ss">:solid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vg">$a_solid</span> <span class="o">=</span> <span class="no">ACoolSolid</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">tick</span> <span class="n">args</span>
</span><span class='line'>  <span class="n">args</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">primitives</span> <span class="o">&lt;&lt;</span> <span class="vg">$a_solid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>But Wait&#8230;</h3>

<p>We are still shoveling an object into <code>args.outputs.primitives</code> each time. Surely that is unnecessary?</p>

<p>Correct! There are <a href="http://docs.dragonruby.org/#------static_solids-"><em>static</em> versions</a> for each <code>args.outputs</code> (e.g. <code>args.outputs.static_solids</code>) that do <em>not</em> get cleared every tick.</p>

<p>Naturally, this is more efficient than creating objects and updating the outputs 60 times per second.</p>

<p>We&#8217;ll explore these options in a future post, but be aware they are available!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/11/08/fixing-just-one-false-positive-in-brakeman/">Fixing Just One False Positive in Brakeman</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-11-08T11:30:00-08:00" pubdate data-updated="true">Nov 8<span>th</span>, 2021</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A while ago, I came across a <a href="https://brakemanscanner.org/">Brakeman</a> false positive that I wanted to fix.</p>

<p>For just one false positive, it became a bit of an epic journey.</p>

<p>The code looked something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">enum</span> <span class="ss">status</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">pending</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">success</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">failed</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="no">NOT_FAILURES</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="o">].</span><span class="n">freeze</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TaskRunner</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_failures</span>
</span><span class='line'>    <span class="n">start_time</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">beginning_of_quarter</span>
</span><span class='line'>    <span class="n">end_time</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">end_of_quarter</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">no_failure_enums</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*</span><span class="no">Task</span><span class="o">::</span><span class="no">NOT_FAILURES</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">QUERY</span>
</span><span class='line'>      <span class="no">SELECT</span> <span class="no">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'>      <span class="no">FROM</span> <span class="sb">`tasks`</span>
</span><span class='line'>      <span class="no">WHERE</span> <span class="sb">`tasks`</span><span class="o">.</span><span class="n">`status</span><span class="sb">` NOT IN (</span><span class="si">#{</span><span class="n">no_failure_enums</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">)</span>
</span><span class='line'><span class="sb">      AND `</span><span class="n">tasks</span><span class="sb">`.`</span><span class="n">time_end</span><span class="sb">` BETWEEN </span><span class="si">#{</span><span class="n">start_time</span><span class="si">}</span><span class="sb"> AND </span><span class="si">#{</span><span class="n">end_time</span><span class="si">}</span><span class="sb"></span>
</span><span class='line'><span class="sb">    QUERY</span>
</span><span class='line'>
</span><span class='line'><span class="sb">    # Line below triggers a SQL injection warning</span>
</span><span class='line'><span class="sb">    Task.connection.select_all(query)</span>
</span><span class='line'><span class="sb">  end</span>
</span><span class='line'><span class="sb">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>(You can imagine in reality the query is a bit more complicated and justifies writing it this way.)</p>

<p>This code results in an SQL injection warning from Brakeman:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Confidence</span><span class="p">:</span> <span class="no">High</span>
</span><span class='line'><span class="ss">Category</span><span class="p">:</span> <span class="no">SQL</span> <span class="no">Injection</span>
</span><span class='line'><span class="ss">Check</span><span class="p">:</span> <span class="no">SQL</span>
</span><span class='line'><span class="ss">Message</span><span class="p">:</span> <span class="no">Possible</span> <span class="no">SQL</span> <span class="n">injection</span>
</span><span class='line'><span class="ss">Code</span><span class="p">:</span> <span class="no">Task</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*)</span><span class="se">\n</span><span class="s2">FROM `filings`</span><span class="se">\n</span><span class="s2">WHERE `filings`.`status` NOT IN (</span><span class="si">#{</span><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">AND `filings`.`time_end` BETWEEN </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">beginning_of_quarter</span><span class="si">}</span><span class="s2"> AND </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">end_of_quarter</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="ss">File</span><span class="p">:</span> <span class="n">app</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">task</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="ss">Line</span><span class="p">:</span> <span class="mi">25</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a little hard to read, so let&#8217;s take a look at a better formatted version of the code Brakeman is complaining about:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span>
</span><span class='line'>  <span class="s2">&quot;SELECT COUNT(*) \</span>
</span><span class='line'><span class="s2">  FROM `filings` \</span>
</span><span class='line'><span class="s2">  WHERE `filings`.`status` NOT IN (</span><span class="si">#{</span><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">) \</span>
</span><span class='line'><span class="s2">  AND `filings`.`time_end` BETWEEN </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">beginning_of_quarter</span><span class="si">}</span><span class="s2"> \</span>
</span><span class='line'><span class="s2">  AND </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">end_of_quarter</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Brakeman is warning about this SQL query because it is using string interpolation to unsafely add in values to the query. If an attacker could control those values, they could modify the SQL run by the database.</p>

<p>In particular, it&#8217;s warning about</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>(the value in <code>no_failure_enums.join(',')</code>).</p>

<p>However, in this case, we know that <code>Task.statuses</code> is actually a constant - it&#8217;s defined using <a href="https://api.rubyonrails.org/v5.2.4.4/classes/ActiveRecord/Enum.html"><code>enum</code></a> in the <code>Task</code> class. This code is just grabbing the integer values for the given enums and joining them back into a comma-separated string.</p>

<p>So how do we get Brakeman to understand that this value is actually safe?</p>

<h2>Splatted Arrays</h2>

<p>Let&#8217;s dive in!</p>

<p>The call we care about:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>First up is <code>*["pending", "success"]</code>. This code converts an array of strings to individual method arguments (i.e., <code>values_at("pending", "success")</code>.</p>

<p>This is pretty easy to handle. In the case where a splatted array is the only argument to a method, just use the elements of the array as the argument list. (Check out the <a href="https://github.com/presidentbeef/brakeman/pull/1564">pull request here</a>)</p>

<p>This gets us to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Better!</p>

<h2>Hash Values</h2>

<p>In this case, <code>values_at</code> is <a href="https://rdoc.info/stdlib/core/Hash:values_at"><code>Hash#values_at</code></a> - it returns an array of values from the hash table for the given keys.</p>

<p>This is also not too difficult to implement. I went ahead and covered <code>Hash#values</code> at the same time. (Check out the <a href="https://github.com/presidentbeef/brakeman/pull/1595">pull request here</a>)</p>

<p>Brakeman will now do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="ss">:a</span><span class="p">,</span> <span class="ss">:c</span><span class="p">)</span>  <span class="c1">#=&gt; [1, 3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great! Back to our code sample, how does it look now?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh&#8230; it looks exactly the same because Brakeman has no idea what <code>Task.statuses</code> is.</p>

<p>Okay, no problem. We just need to implement support for ActiveRecord&#8217;s <code>enum</code>.</p>

<h2>Detour!</h2>

<p>Here I took a little detour. <code>Task.statuses</code> is a method that returns a hash value. Instead of just implementing that, I thought this would be a good time to support methods with single, simple return values.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Dog</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">sound</span>
</span><span class='line'>    <span class="s1">&#39;bark&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If Brakeman could know that <code>Dog.sound</code> returns <code>'bark'</code>, I could implement enums as method definitions that return simple arrays or hashes. (More on this later!)</p>

<p>To implement this functionality, I rewrote how Brakeman tracks methods (as real objects) and updated some method lookup code.</p>

<p>The details aren&#8217;t particularly interesting, but the <a href="https://github.com/presidentbeef/brakeman/pull/1596">code changes are here</a>.</p>

<h2>Back to Enums</h2>

<p>Calling <code>enum</code> essentially defines a bunch of methods.</p>

<p>For example this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">enum</span> <span class="ss">status</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">pending</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">success</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">failed</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Will define methods like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span> <span class="c1"># the one we care about!</span>
</span><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">status</span>
</span><span class='line'><span class="no">Task</span><span class="c1">#status</span>
</span><span class='line'><span class="no">Task</span><span class="c1">#pending?</span>
</span><span class='line'><span class="no">Task</span><span class="c1">#success?</span>
</span><span class='line'><span class="c1"># ..etc.</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can pass in an explicit hash mapping keys to values or just an array of keys and Rails will do the mapping.</p>

<p>To implement this in Brakeman, we simulate the creation of the <code>status</code> and <code>statuses</code> methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">statuses</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="ss">pending</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">success</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">failed</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then rely on the previous changes for <code>Task.statuses</code> now returning a hash.</p>

<h2>Another Detour</h2>

<p>You might have noticed that the enum definition uses <code>status</code> but we need <code>statuses</code>.</p>

<p>This required <a href="https://github.com/presidentbeef/brakeman/commit/c27f44ab8bf1d8dfad6c5e5908ba621ec067f9a7">a tiny tweak</a> to Brakeman&#8217;s extremely over-simplified <code>pluralize</code>.</p>

<h2>Back to the False Positive</h2>

<p>Where are we now?</p>

<p>With <code>enum</code> support and proper pluralization, this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Gets reduced like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="ss">pending</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">success</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">failed</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="o">*[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="ss">pending</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">success</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">failed</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="ss">:BRAKEMAN_SAFE_LITERAL</span><span class="p">,</span> <span class="ss">:BRAKEMAN_SAFE_LITERAL</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;BRAKEMAN_SAFE_LITERAL,BRAKEMAN_SAFE_LITERAL&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well&#8230; it&#8217;s not perfect. Note that the array values are strings, but our enum uses symbol keys. But Brakeman knows the enum is all literal values which are safe, so we end up with this.</p>

<p>The query now looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Task</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span>
</span><span class='line'>  <span class="s2">&quot;SELECT COUNT(*) \</span>
</span><span class='line'><span class="s2">  FROM `filings` \</span>
</span><span class='line'><span class="s2">  WHERE `filings`.`status` NOT IN (</span><span class="si">#{</span><span class="s2">&quot;BRAKEMAN_SAFE_LITERAL,BRAKEMAN_SAFE_LITERAL&quot;</span><span class="si">}</span><span class="s2">) \</span>
</span><span class='line'><span class="s2">  AND `filings`.`time_end` BETWEEN </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">beginning_of_quarter</span><span class="si">}</span><span class="s2"> \</span>
</span><span class='line'><span class="s2">  AND </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">end_of_quarter</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, not perfect but at least Brakeman isn&#8217;t going to warn about interpolating a string literal into the query.</p>

<h2>Not Done Yet</h2>

<p>Ah, but wait. The warning is not gone!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Confidence</span><span class="p">:</span> <span class="no">Medium</span>
</span><span class='line'><span class="ss">Category</span><span class="p">:</span> <span class="no">SQL</span> <span class="no">Injection</span>
</span><span class='line'><span class="ss">Check</span><span class="p">:</span> <span class="no">SQL</span>
</span><span class='line'><span class="ss">Message</span><span class="p">:</span> <span class="no">Possible</span> <span class="no">SQL</span> <span class="n">injection</span>
</span><span class='line'><span class="ss">Code</span><span class="p">:</span> <span class="no">Task</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*)</span><span class="se">\n</span><span class="s2">FROM `filings`</span><span class="se">\n</span><span class="s2">WHERE `filings`.`status` NOT IN (</span><span class="si">#{</span><span class="s2">&quot;BRAKEMAN_SAFE_LITERAL,BRAKEMAN_SAFE_LITERAL&quot;</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">AND `filings`.`time_end` BETWEEN </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">beginning_of_quarter</span><span class="si">}</span><span class="s2"> AND </span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">end_of_quarter</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="ss">File</span><span class="p">:</span> <span class="n">app</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">task</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="ss">Line</span><span class="p">:</span> <span class="mi">25</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&#8217;s wrong now?</p>

<p>Brakeman doesn&#8217;t know what <code>Date.beginning_of_quarter</code> or <code>Date.end_of_quarter</code> are, so it generates a lower confidence warning about it. For SQL injection, Brakeman is pretty paranoid about any string interpolation, even if it&#8217;s not sure the values are &#8220;dangerous&#8221;.</p>

<p>But anything coming from <code>Date</code> is likely to be safe, so now <a href="https://github.com/presidentbeef/brakeman/pull/1615">Brakeman ignores <code>Date</code> calls in SQL</a>.</p>

<h2>Whew. Done?</h2>

<p>Yep - now that code will no longer warn.</p>

<p>Except&#8230; in the months it took me to address this false positive, the code has changed in such a way that Brakeman now has a false <em>negative</em> problem (should be warning about some things, but isn&#8217;t). But that&#8217;s a different problem for a different day.</p>

<p>At least that one false positive is fixed!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/07/21/rails-6-dot-1-sql-injection-updates/">Rails 6.1 SQL Injection Updates</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-07-21T12:14:00-07:00" pubdate data-updated="true">Jul 21<span>st</span>, 2021</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since early 2013, I have been maintaining <a href="https://rails-sqli.org">rails-sqli.org</a>, a collection of Rails ActiveRecord methods that can be vulnerable to <a href="https://guides.rubyonrails.org/security.html#sql-injection">SQL injection</a>.</p>

<p>Rails 6 has been out <a href="https://guides.rubyonrails.org/6_0_release_notes.html">since December 2019</a>, but sadly the site has been missing information about changes and new methods in Rails 6.</p>

<p>As that deficiency has recently been rectified, let&#8217;s walk through what has changed since Rails 5!</p>

<h2><code>delete_all</code>, <code>destroy_all</code></h2>

<p>In earlier versions of Rails, <code>delete_all</code> and <code>destroy_all</code> could be passed a string of raw SQL.</p>

<p>In Rails 6, these two methods no longer accept any arguments.</p>

<p>Instead, you can use&#8230;</p>

<h2><code>delete_by</code>, <code>destroy_by</code></h2>

<p>New in Rails 6, <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Relation.html#method-i-delete_by"><code>delete_by</code></a> and <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Relation.html#method-i-destroy_by"><code>destroy_by</code></a> accept the same type of arguments as <code>where</code>: a Hash, an Array, or a raw SQL String.</p>

<p>This means they are vulnerable to the same kind of SQL injection.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;1) OR 1=1--&quot;</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">delete_by</span><span class="p">(</span><span class="s2">&quot;id = </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Resulting query that deletes all users:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;users&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">OR</span> <span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="c1">--)</span>
</span></code></pre></td></tr></table></div></figure>


<h2><code>order</code>, <code>reorder</code></h2>

<p>Prior to Rails 6, it was possible to pass arbitrary SQL to the <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/QueryMethods.html#method-i-order"><code>order</code></a> and <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/QueryMethods.html#method-i-reorder"><code>reorder</code></a> methods.</p>

<p>Since Rails did not offer an easy way of setting sort direction, this kind of code was common:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">&quot;name </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:direction</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Rails 6.0, injection attempts would raise a deprecation warning:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">DEPRECATION</span> <span class="ss">WARNING</span><span class="p">:</span> <span class="no">Dangerous</span> <span class="n">query</span> <span class="nb">method</span> <span class="p">(</span><span class="nb">method</span> <span class="n">whose</span> <span class="n">arguments</span> <span class="n">are</span> <span class="n">used</span> <span class="n">as</span> <span class="n">raw</span> <span class="no">SQL</span><span class="p">)</span> <span class="n">called</span> <span class="n">with</span> <span class="n">non</span><span class="o">-</span><span class="n">attribute</span> <span class="n">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="s2">&quot;--&quot;</span><span class="o">.</span> <span class="no">Non</span><span class="o">-</span><span class="n">attribute</span> <span class="n">arguments</span> <span class="n">will</span> <span class="n">be</span> <span class="n">disallowed</span> <span class="k">in</span> <span class="no">Rails</span> <span class="mi">6</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span> <span class="no">This</span> <span class="nb">method</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">called</span> <span class="n">with</span> <span class="n">user</span><span class="o">-</span><span class="n">provided</span> <span class="n">values</span><span class="p">,</span> <span class="n">such</span> <span class="n">as</span> <span class="n">request</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="n">model</span> <span class="n">attributes</span><span class="o">.</span> <span class="no">Known</span><span class="o">-</span><span class="n">safe</span> <span class="n">values</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">by</span> <span class="n">wrapping</span> <span class="n">them</span> <span class="k">in</span> <span class="no">Arel</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Starting with Rails 6.1, some logic to check the arguments to <code>order</code>. If the arguments do not appear to be column names or sort order, they will be rejected:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;</span> <span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">&quot;name ARGLBARGHL&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>        <span class="mi">1</span><span class="p">:</span> <span class="n">from</span> <span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">12</span>
</span><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">UnknownAttributeReference</span> <span class="p">(</span><span class="no">Query</span> <span class="nb">method</span> <span class="n">called</span> <span class="n">with</span> <span class="n">non</span><span class="o">-</span><span class="n">attribute</span> <span class="n">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="s2">&quot;name ARGLBARGHL&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is still possible to inject additional columns to extract some information from the table, such as number of columns or names of the columns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">[</span><span class="ss">:direction</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;, 8&quot;</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">&quot;name </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:direction</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Resulting exception:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">StatementInvalid</span> <span class="p">(</span><span class="no">SQLite3</span><span class="o">::</span><span class="ss">SQLException</span><span class="p">:</span> <span class="mi">2</span><span class="n">nd</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">term</span> <span class="n">out</span> <span class="n">of</span> <span class="n">range</span> <span class="o">-</span> <span class="n">should</span> <span class="n">be</span> <span class="n">between</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">7</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2><code>pluck</code></h2>

<p><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-pluck"><code>pluck</code></a> pulls out specified columns from a query, instead of loading whole records.</p>

<p>In previous versions of Rails, <code>pluck</code> (somewhat surprisingly!) accepted arbitrary SQL strings if they were passed in as an array.</p>

<p>Like <code>order</code>/<code>reorder</code>, Rails 6.0 started warning about this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">&gt;</span> <span class="no">User</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;1&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="no">DEPRECATION</span> <span class="ss">WARNING</span><span class="p">:</span> <span class="no">Dangerous</span> <span class="n">query</span> <span class="nb">method</span> <span class="p">(</span><span class="nb">method</span> <span class="n">whose</span> <span class="n">arguments</span> <span class="n">are</span> <span class="n">used</span> <span class="n">as</span> <span class="n">raw</span> <span class="no">SQL</span><span class="p">)</span> <span class="n">called</span> <span class="n">with</span> <span class="n">non</span><span class="o">-</span><span class="n">attribute</span> <span class="n">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="o">[</span><span class="s2">&quot;1&quot;</span><span class="o">].</span> <span class="no">Non</span><span class="o">-</span><span class="n">attribute</span> <span class="n">arguments</span> <span class="n">will</span> <span class="n">be</span> <span class="n">disallowed</span> <span class="k">in</span> <span class="no">Rails</span> <span class="mi">6</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span> <span class="no">This</span> <span class="nb">method</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">called</span> <span class="n">with</span> <span class="n">user</span><span class="o">-</span><span class="n">provided</span> <span class="n">values</span><span class="p">,</span> <span class="n">such</span> <span class="n">as</span> <span class="n">request</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="n">model</span> <span class="n">attributes</span><span class="o">.</span> <span class="no">Known</span><span class="o">-</span><span class="n">safe</span> <span class="n">values</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">by</span> <span class="n">wrapping</span> <span class="n">them</span> <span class="k">in</span> <span class="no">Arel</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Rails 6.1, <code>pluck</code> now only accepts attribute names!</p>

<h2><code>reselect</code></h2>

<p>Rails 6 introduced <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/QueryMethods.html#method-i-reselect"><code>reselect</code></a>, which allows one to completely replace the <code>SELECT</code> clause of a query. Like <code>select</code>, it accepts any SQL string. Since <code>SELECT</code> is at the very beginning of the SQL query, it makes it a great target for SQL injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">[</span><span class="ss">:column</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;* FROM orders -- &quot;</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">reselect</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:column</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note this selects <em>all</em> columns <em>from a different table</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">orders</span> <span class="c1">-- FROM &quot;users&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2><code>rewhere</code></h2>

<p><a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/QueryMethods.html#method-i-rewhere"><code>rewhere</code></a> is analogous to <code>reselect</code> but it replaces the <code>WHERE</code> clause.</p>

<p>Like <code>where</code>, it is very easy to open up <code>rewhere</code> to SQL injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">[</span><span class="ss">:age</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;1=1) OR 1=1--&quot;</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rewhere</span><span class="p">(</span><span class="s2">&quot;age &gt; </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:age</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Resulting query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SELECT</span> <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;users&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="p">?</span> <span class="no">AND</span> <span class="p">(</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="no">OR</span> <span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="o">--</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrapping Up</h2>

<p>Any other new methods that allow SQL injection? Let me know!</p>

<p>Want to find out more?</p>

<ul>
<li><a href="https://rails-sqli.org">rails-sqli.org</a> for the complete list.</li>
<li><a href="https://brakemanscanner.org/">Brakeman</a> to help find vulnerable queries in your code.</li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">OWASP SQL Injection Cheat Sheet</a> to learn more about preventing SQL injection.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/09/14/another-reason-to-avoid-constantize-in-rails/">Another Reason to Avoid Constantize in Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-09-14T08:37:00-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2020</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Backstory</h2>

<p>Recently, a friend asked me if <em>just</em> calling <code>constantize</code> on user input was dangerous, even if subsequent code did not use the result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">[</span><span class="ss">:class</span><span class="o">].</span><span class="n">classify</span><span class="o">.</span><span class="n">constantize</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://brakemanscanner.org/">Brakeman</a> generates a &#8220;remote code execution&#8221; warning for this code:</p>

<pre>
<font color="#00C300">Confidence</font>: <font color="#AA0000">High</font>
<font color="#00C300">Category</font>: Remote Code Execution
<font color="#00C300">Check</font>: UnsafeReflection
<font color="#00C300">Message</font>: Unsafe reflection method `constantize` called with parameter value
<font color="#00C300">Code</font>: <font color="#6C009B">params[:class].classify</font>.constantize
<font color="#00C300">File</font>: app/controllers/users_controller.rb
<font color="#00C300">Line</font>: 7
</pre>


<p>But why? Surely just converting a string to a constant (if the constant even exists!) can&#8217;t be dangerous, right?</p>

<p>Coincidentally, around that same time I was looking at Ruby deserialization gadgets - in particular <a href="https://www.elttam.com/blog/ruby-deserialization/">this one</a> which mentions that Ruby&#8217;s <code>Digest</code> module will load a file based on the module name. For example, <code>Digest::A</code> will try to <code>require 'digest/a'</code>:</p>

<pre>2.7.0 :001 &gt; require <font color="#FF5555"><b>&apos;</b></font><font color="#AA0000">digest</font><font color="#FF5555"><b>&apos;</b></font>
 =&gt; <font color="#55FFFF"><b>true</b></font> 
2.7.0 :002 &gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>Digest</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>Whatever</b></u></font>
<font color="#DEDEDE"><b>Traceback</b></font> (most recent call last):
        5: from /home/justin/.rvm/rubies/ruby-2.7.0/bin/irb:23:in `&lt;main&gt;&apos;
        4: from /home/justin/.rvm/rubies/ruby-2.7.0/bin/irb:23:in `load&apos;
        3: from /home/justin/.rvm/rubies/ruby-2.7.0/lib/ruby/gems/2.7.0/gems/irb-1.2.1/exe/irb:11:in `&lt;top (required)&gt;&apos;
        2: from (irb):2
        1: from /home/justin/.rvm/rubies/ruby-2.7.0/lib/ruby/2.7.0/digest.rb:16:in `const_missing&apos;
<font><b>LoadError (</b><u style="text-decoration-style:single"><b>library not found for class Digest::Whatever -- digest/whatever</b></u><b>)</b></font></pre>


<p>The <code>Digest</code> library uses the <a href="https://rdoc.info/stdlib/core/Module:const_missing"><code>const_missing</code></a> hook to implement this functionality.</p>

<p>This made me wonder if <code>constantize</code> and <code>const_missing</code> could be connected, and what the consequences would be.</p>

<h2>Constantizing in Rails</h2>

<p>The <code>constantize</code> method in Rails <a href="https://api.rubyonrails.org/classes/String.html#method-i-constantize">turns a string into a constant</a>. If the constant does not exist then a <code>NameError</code> will be raised.</p>

<p>However, it is possible to hook into the constant lookup process in Ruby by defining a <code>const_missing</code> method. If a constant cannot be found in a given module, and that module has <code>const_missing</code> defined, then <code>const_missing</code> will be invoked.</p>

<pre>2.7.0 :001 &gt; <font color="#00C300">module</font> <font color="#5555FF"><u style="text-decoration-style:single"><b>X</b></u></font>
2.7.0 :002 &gt;   <font color="#00C300">def</font> <font color="#55FFFF"><b>self</b></font>.<font color="#5555FF"><b>const_missing</b></font>(name)
2.7.0 :003 &gt;     puts <font color="#FF5555"><b>&quot;</b></font><font color="#AA0000">You tried to load #{</font>name.inspect<font color="#AA0000">}</font><font color="#FF5555"><b>&quot;</b></font>
2.7.0 :004 &gt;   <font color="#00C300">end</font>
2.7.0 :005 &gt; <font color="#00C300">end</font>
 =&gt; <font color="#6C009B">:const_missing</font> 
2.7.0 :006 &gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>X</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>Hello</b></u></font>
You tried to load :Hello
 =&gt; <font color="#55FFFF"><b>nil</b></font></pre>


<p>If <code>const_missing</code> is implemented with behavior based on the constant name, such as loading a file or creating a new object, there is an opportunity for malicious behavior.</p>

<h2>Some Vulnerable Gems</h2>

<p>Fortunately, <code>const_missing</code> is not used very often. When it is, the implementation is not usually exploitable.</p>

<p>Searching across ~1300 gems, I found only ~40 gems with a <code>const_missing</code> implementation.</p>

<p>Of those, the majority were not exploitable because they checked the constant name against expected values or called <code>const_get</code> which raises an exception if the constant does not exist.</p>

<p>One gem, <a href="https://github.com/rubychan/coderay">coderay</a>, <a href="https://github.com/rubychan/coderay/blob/d38502167541a1cd1b505a0e468e0098e3ae7538/lib/coderay/helpers/plugin_host.rb#L59-L67">loads files based on constant names</a> like the Digest library. Also like the Digest library, this does not appear to be exploitable because the files are limited to a single coderay directory.</p>

<p>The next two gems below have memory leaks, which can enable denial of service attacks through memory exhaustion.</p>

<h3>Temple</h3>

<p>The <a href="https://github.com/judofyr/temple">Temple</a> gem is a foundational gem used by Haml, Slim, and other templating libraries.</p>

<p>In Temple, there is a module called <code>Temple::Mixins::GrammarDSL</code> that implements <code>const_missing</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">const_missing</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">const_set</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="no">Root</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="nb">name</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method creates a new constant based on the given <code>name</code> and assigns a new object.</p>

<p>This is a memory leak since constants are never garbage collected. If an attacker can trigger it, they can create an unlimited number of permanent objects, using up as much memory as possible.</p>

<p>Unfortunately, it is easy to exploit this code.</p>

<p><code>Temple::Grammar</code> extends <code>Template::Mixins::GrammarDSL</code> and is a core class for Temple. Let&#8217;s see if it is loaded by Haml, a popular templating library often used with Rails:</p>

<pre>2.7.0 :001 &gt; require <font color="#FF5555"><b>&apos;</b></font><font color="#AA0000">haml</font><font color="#FF5555"><b>&apos;</b></font>
 =&gt; <font color="#55FFFF"><b>true</b></font> 
2.7.0 :002 &gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>Temple</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>Grammar</b></u></font>
 =&gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>Temple</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>Grammar</b></u></font> </pre>


<p>Great! What happens if we try to reference a module that definitely does not exist?</p>

<pre>2.7.0 :003 &gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>Temple</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>Grammar</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>DefinitelyDoesNotExist</b></u></font>
 =&gt; #&lt;Temple::Mixins::GrammarDSL::Root:0x000055a79b011060 @grammar=Temple::Grammar, @children=[], @name=:DefinitelyDoesNotExist&gt; </pre>


<p>As can be seen above, the constant is created along with a new object.</p>

<p>To go one step further&#8230; does the use of constantize invoke this code?</p>

<p>We can test by loading a Rails console for an application using Haml:</p>

<pre>Loading development environment (Rails 6.0.3.2)
2.7.0 :001 &gt; require <font color="#FF5555"><b>&apos;</b></font><font color="#AA0000">haml</font><font color="#FF5555"><b>&apos;</b></font>
 =&gt; <font color="#55FFFF"><b>false</b></font> 
2.7.0 :002 &gt; <font color="#FF5555"><b>&apos;</b></font><font color="#AA0000">Temple::Grammar::DefinitelyDoesNotExist</font><font color="#FF5555"><b>&apos;</b></font>.constantize
 =&gt; #&lt;Temple::Mixins::GrammarDSL::Root:0x000055ba28031a50 @grammar=Temple::Grammar, @children=[], @name=:DefinitelyDoesNotExist&gt; 
</pre>


<p>It does!</p>

<p>Any Ruby on Rails application using Haml or Slim that calls <code>constantize</code> on user input (e.g. <code>params[:class].classify.constantize</code>) is vulnerable to a memory leak via this method.</p>

<h3>Restforce</h3>

<p>A very similar code pattern is implemented in the <a href="https://github.com/restforce/restforce">restforce</a> gem.</p>

<p>The <a href="https://github.com/restforce/restforce/blob/b14175a9072fb6333c1c1b3dce2bb498c022a1b3/lib/restforce.rb#L65-L67">ErrorCode module</a> uses <code>const_missing</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ErrorCode</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">const_missing</span><span class="p">(</span><span class="n">constant_name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">const_set</span> <span class="n">constant_name</span><span class="p">,</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ResponseError</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nearly the same, except this actually creates new <em>classes</em>, not just regular objects.</p>

<p>We can verify again:</p>

<pre>Loading development environment (Rails 6.0.3.2)
2.7.0 :001 &gt; require <font color="#FF5555"><b>&apos;</b></font><font color="#AA0000">restforce</font><font color="#FF5555"><b>&apos;</b></font>
 =&gt; <font color="#55FFFF"><b>false</b></font> 
2.7.0 :002 &gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>Restforce</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>ErrorCode</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>WhateverWeWant</b></u></font>
 =&gt; <font color="#5555FF"><u style="text-decoration-style:single"><b>Restforce</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>ErrorCode</b></u></font>::<font color="#5555FF"><u style="text-decoration-style:single"><b>WhateverWeWant</b></u></font> 
</pre>


<p>This time we get as many new classes as we want.</p>

<p><strong>This has been fixed in <a href="https://github.com/restforce/restforce/blob/master/CHANGELOG.md#500-jul-10-2020">Restforce 5.0.0</a>.</strong></p>

<h2>Finding and Exploiting Memory Leaks</h2>

<p><em>Finding</em> vulnerable code like this in a production application would be difficult. You would need to guess which parameters might be <code>constantize</code>d.</p>

<p>Verifying that you&#8217;ve found a memory leak is a little tricky and the two memory leaks described above create very minimal objects.</p>

<p>From what I could estimate, a new <code>Rule</code> object in Temple uses about 300 bytes of memory, while a new class in Restforce was taking up almost 1,000 bytes.</p>

<p>Based on that and my testing, it would take 1 to 4 million requests to use just 1GB of memory.</p>

<p>Given that web applications are usually restarted on a regular basis and it&#8217;s not usually a big deal to kill off a process and start a new one, this does not seem particularly impactful.</p>

<p>However, it would be annoying and possibly harmful for smaller sites. For example, the base Heroku instance only has 512MB of memory.</p>

<p>Another note here: Memory leaks are not the worst outcome of an unprotected call to <code>constantize</code>. More likely it can trigger remote code execution. The real issue I am trying to explore here is the unexpected behavior that may be hidden in dependencies.</p>

<h2>Conclusions</h2>

<p>In short: Avoid using <code>constantize</code> in Rails applications. If you need to use it, check against an allowed set of class names <em>before</em> calling <code>constantize</code>. (Calling <code>classify</code> before checking is okay, though.)</p>

<p>Likewise for <code>const_missing</code> in Ruby libraries. Doing anything dynamic with the constant name (loading files, creating new objects, evaluating code, etc.) should be avoided. Ideally, check against an expected list of names and reject anything else.</p>

<p>In the end, this comes down to the security basics of not trusting user input and strictly validating inputs.</p>

<p><em>Edit:</em> It seems some language I used above was a little ambiguous, so I tweaked it. Calling <code>classify</code> does not make the code safe - I meant calling <code>classify</code> is not dangerous by itself. It&#8217;s the subsequent call to <code>constantize</code> that is dangerous. So you can safely call <code>classify</code>, check against a list of allowed classes, then take the appropriate action.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/12/why-escape-javascript-is-dangerous/">Why &#8216;Escaping&#8217; JavaScript Is Dangerous</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-05-12T11:40:00-07:00" pubdate data-updated="true">May 12<span>th</span>, 2020</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A recent <a href="https://github.com/rails/rails/security/advisories/GHSA-65cv-r6x7-79hv">vulnerability report</a> and <a href="https://chefsecure.com/blog/i-found-xss-security-flaws-in-rails-heres-what-happened">the blog post behind it</a> brought my attention back to the <a href="https://api.rubyonrails.org/v6.0.0/classes/ActionView/Helpers/JavaScriptHelper.html#method-i-escape_javascript"><code>escape_javascript</code></a> Ruby on Rails helper method.</p>

<blockquote class="twitter-tweet" data-dnt="true"><p lang="en" dir="ltr">Let me say it again&#8230; if you are calling `escape_javascript` or `j` in your Rails code, please don&#39;t! <a href="https://t.co/60KLEjHX3T">https://t.co/60KLEjHX3T</a></p>&mdash; Justin Collins (@presidentbeef) <a href="https://twitter.com/presidentbeef/status/1258917835977318400?ref_src=twsrc%5Etfw">May 9, 2020</a></blockquote>


<p> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>It&#8217;s bad form to drop blanket statements without explanation or evidence, so here it is:</p>

<h3>Escaping HTML</h3>

<p>Part of the danger of <code>escape_javascript</code> is the <strong>name</strong> and apparent relationship to <a href="https://api.rubyonrails.org/v6.0.0/classes/ERB/Util.html#method-c-html_escape"><code>html_escape</code></a>.</p>

<p>HTML is a markup language for writing documents. Therefore, it must have a method for representing itself in text.
In other words, there must be a way to encode <code>&lt;b&gt;</code> such that the browser <em>displays</em> <code>&lt;b&gt;</code> and does not interpret it as HTML.</p>

<p>As a result, HTML has a well-defined HTML encoding strategy.
In the context of security and <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html">cross-site scripting</a>, if a value output in an HTML context is <em>HTML escaped</em>, it is safe - the value will not be interpreted as HTML.</p>

<p><em>(<a href="https://blog.presidentbeef.com/blog/2020/01/14/injection-prevention-sanitizing-vs-escaping/">See my post all about escaping!</a>)</em></p>

<h3>Escaping Javascript</h3>

<p>On the other hand, JavaScript has no such escaping requirements or capabilities.</p>

<p>Therefore, the &#8220;escaping&#8221; performed by <code>escape_javascript</code> is limited.
The <a href="https://github.com/rails/rails/security/advisories/GHSA-65cv-r6x7-79hv">vulnerability report</a> states the method is for &#8220;escaping JavaScript string literals&#8221;.</p>

<p>In particular, <code>escape_javascript</code> is only useful in one, single context: inside JavaScript strings!</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x"># ERb Template</span>
</span><span class='line'><span class="x">&lt;script&gt;</span>
</span><span class='line'><span class="x">  var x = &#39;</span><span class="cp">&lt;%=</span> <span class="n">escape_javascript</span> <span class="n">some_value</span> <span class="cp">%&gt;</span><span class="x">&#39;;</span>
</span><span class='line'><span class="x">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Use of <code>escape_javascript</code> in any other context is incorrect and dangerous!</strong></p>

<p>This is and always has been dangerous (note the missing quotes):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x"># ERb Template</span>
</span><span class='line'><span class="x">&lt;script&gt;</span>
</span><span class='line'><span class="x">  var x = </span><span class="cp">&lt;%=</span> <span class="n">escape_javascript</span> <span class="n">some_value</span> <span class="cp">%&gt;</span><span class="x">;</span>
</span><span class='line'><span class="x">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>some_value</code> could be a payload like <code>1; do_something_shady(); //</code> which would result in the following HTML:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">do_something_shady</span><span class="p">();</span> <span class="c1">//; </span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>escape_javascript</code> helper <strong>does not</strong> and <strong>cannot</strong> make arbitrary values inserted into JavaScript &#8220;safe&#8221; in the same way <code>html_escape</code> makes values safe for HTML.</p>

<h3>CVE-2020-5267</h3>

<p><a href="https://chefsecure.com/blog/i-found-xss-security-flaws-in-rails-heres-what-happened">Jesse&#8217;s post</a> has more details, but here&#8217;s the gist: JavaScript added a new string literal. Instead of just single and double-quotes, now there are also backticks <code>`</code> which support string interpolation (like Ruby!).</p>

<p>This meant it was simple to bypass <code>escape_javascript</code> and execute arbitrary JavaScript by using a backtick to break out of the string or just <code>#{...}</code> to execute code during interpolation.</p>

<p>For example, if this were our code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x"># ERb Template</span>
</span><span class='line'><span class="x">&lt;script&gt;</span>
</span><span class='line'><span class="x">  var x = `</span><span class="cp">&lt;%=</span> <span class="n">escape_javascript</span> <span class="n">some_value</span> <span class="cp">%&gt;</span><span class="x">`;</span>
</span><span class='line'><span class="x">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then if <code>some_value</code> had a payload of <code>`; do_something_shady(); //</code>, the resulting HTML would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="err">``</span><span class="p">;</span> <span class="nx">do_something_shady</span><span class="p">();</span> <span class="c1">//`</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is because <code>escape_javascript</code> was not aware of backticks for strings.</p>

<h3>Dangers of Dynamic Code Generation</h3>

<blockquote class="twitter-tweet" data-dnt="true"><p lang="en" dir="ltr">Let me say it again using dynamic javascript under practically any circumstance is inviting trouble. It might be ok. Id rather not have to worry about it. <a href="https://t.co/wnPy3OnkKI">https://t.co/wnPy3OnkKI</a></p>&mdash; Shake, Oreo (@ndm) <a href="https://twitter.com/ndm/status/1258982525172510720?ref_src=twsrc%5Etfw">May 9, 2020</a></blockquote>


<p> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>As I have <a href="https://youtu.be/g_24036NDhM">talked about before</a>, web applications are essentially poorly-defined compilers generating code with untrusted inputs.
In the end, the server is just returning a mishmash of code for the browser to interpret.</p>

<p>However, directly trying to generate safe code in a Turing-complete language like JavaScript or Ruby via string manipulation is a risky game.
Methods like <code>escape_javascript</code> make it tempting to do so because the name sounds like it will make the code safe.</p>

<p>If at all possible, avoid dynamic code generation!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Justin Collins -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
  <span class="credit">Theme by <a href="http://aron.cedercrantz.com/">Aron Cedercrantz</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'presidentbeefblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
